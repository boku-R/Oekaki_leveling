<%= flash[:notice] %>
<h2>作品の詳細ページです</h2>

<!--投稿主のユーザを表示-->
<%= link_to user_path(@user) do %>
  <%= image_tag @user.get_profile_image(100,100) %>
<% end %>
<%= @user.handlename %>
<% if @user != current_user %>
  <% if current_user.following?(@user) %>
    <%= link_to "フォロー外す", user_relationships_path(@user.id), method: :delete, class:"btn btn-danger" %>
  <% else %>
    <%= link_to "フォローする", user_relationships_path(@user.id), method: :post, class:"btn btn-success" %>
  <% end %>
<% end %>

【タイトル：<%= @post.title %>】
【説明：<%= @post.introduction %>】
【タグ：
  <% @post_tags.each do |tag| %>
    <%= link_to tag.name, search_tag_path(tag_id: tag.id) %><%= "(#{tag.posts.count})" %>
  <% end %>
  】
<% if @post.user_id == current_user.id %>
  <%= link_to "投稿を削除", post_path(@post), method: :delete, class:"btn btn-danger" %>
<% end %>
<table class = "table">
  <tbody>
    <% @post.illusts.each do |illust| %>
      <tr>
        <th>
          <% if illust.illust_image.present? %>
            <%= link_to post_path(illust.post_id) do %>
              <!--リサイズ→真ん中を正方形にくり抜きます-->
              <p><%= image_tag illust.illust_image.variant(resize: "150x150", gravity: "center", crop: "100x100+0+0").processed %></p>
            <% end %>
          <% else %>
            <%= image_tag 'no_image', size: "150x150" %>
          <% end %>
        </th>
        <th><%= I18n.t("enums.illust.step.#{Illust.steps.keys[Illust.steps[illust.step]]}") %></th>
        <%# byebug %>
        <th>
          <% if illust.illust_image.present? %>
            <% if illust.favorited_by?(current_user) %>
              <p>
                <%= link_to post_favorites_path(@post,illust_id: illust.id), method: :delete do %>
                  ♥<%= illust.favorites.count %> いいね
                <% end %>
              </p>
            <% else %>
              <p>
                <%= link_to post_favorites_path(@post,illust_id: illust.id), method: :post do %>
                  ♡<%= illust.favorites.count %> いいね
                <% end %>
              </p>
            <% end %>
          <% end %>
        </th>
      </tr>
    <% end %>
    <tr>
      <% if current_user == @user %>
        <th><%= link_to "投稿を編集する", edit_post_path(params[:id]), method: :get, class:"btn btn-success" %></th>
      <% end %>
    </tr>
    <tr>
      <th>
        <p>コメント件数：<%= @post.post_comments.count %></p>
      </th>
    </tr>
    <% @post.post_comments.each do |post_comment| %>
      <tr>
        <th>
          <% if post_comment.is_deleted == false %>
            <p><%= image_tag post_comment.user.get_profile_image(100,100) %></p>
            <%= post_comment.user.username %>
            <%= post_comment.created_at.strftime('%Y/%m/%d') %><%= post_comment.comment %>
            <% if post_comment.user == current_user %>
              <%= link_to "コメント削除", post_post_comment_path(post_comment.post, post_comment), method: :delete %>
            <% end %>
          <% else %>
            <p>コメントは削除されました</p>
          <% end %>
        </th>
      </tr>
    <% end %>
    <tr>
      <th>
        <%= form_with model: [@post, @post_comment] do |f| %>
          <%= f.text_area :comment, rows: '5', placeholder: "コメントをここに" %>
          <%= f.submit "送信する" %>
        <% end %>
      </th>
    </tr>
  </tbody>
</table>
